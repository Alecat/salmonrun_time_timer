!function(t){var e={};function s(i){if(e[i])return e[i].exports;var n=e[i]={i:i,l:!1,exports:{}};return t[i].call(n.exports,n,n.exports,s),n.l=!0,n.exports}s.m=t,s.c=e,s.d=function(t,e,i){s.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},s.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},s.t=function(t,e){if(1&e&&(t=s(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(s.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var n in t)s.d(i,n,function(e){return t[e]}.bind(null,n));return i},s.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return s.d(e,"a",e),e},s.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},s.p="",s(s.s=1)}([function(t,e,s){var i;i=function(t,e,s){var i;if(XMLHttpRequest)i=new XMLHttpRequest;else if(ActiveXObject)try{i=new ActiveXObject("Msxml2.XMLHTTP")}catch(t){try{i=new ActiveXObject("Microsoft.XMLHTTP")}catch(t){}}if(!i)return e.call(this,"Giving up :( Cannot create an XMLHTTP instance",null),!1;i.onreadystatechange=function(){if(4===i.readyState)if(i.status>=200&&i.status<400){var t=i.responseText;if(!(!(!s||!s.hasOwnProperty("raw"))&&s.raw))try{t=JSON.parse(t)}catch(t){return void e.call(this,t,null)}e.call(this,null,t)}else e.call(this,new Error("There was a problem with the request"),null)};var n=s&&s.method?s.method:"GET";if("GET"==n){var o=[];if(s&&s.params&&"object"==typeof s.params)for(var r in s.params)o.push(r+"="+encodeURIComponent(s.params[r]));t=o.length>0?t+"?"+o.join("&"):t,i.open("GET",t),i.send()}else if("POST"==n){var a=s&&s.data?s.data:s.params?s.params:{};i.open("POST",t),i.send(JSON.stringify(a))}return i},t.exports&&(t.exports=i),"undefined"!=typeof window&&(window.getJSONData=i)},function(t,e,s){"use strict";s.r(e);var i=class{constructor(t=null){this.time_offset=t}listup_next_STT(t=Date.now()){var e,s=[];e=this.time_offset?this.time_offset.get_time(t):new Date(t);for(var i=Math.floor((e.getMinutes()-2)/8)+1,n=e.getHours();s.length<7;){for(var o=i+1;o<=7&&s.length<7;++o){var r=2+8*(o-1),a=new Date(e);a.setHours(n),a.setMinutes(r),a.setSeconds(0),a.setMilliseconds(0),s.push(a)}i=0,n+=1}return s}};var n=class{constructor(){}getMonthText(t){var e=t.getMonth()+1,s=t.getDate();e<10&&(e="0"+e),s<10&&(s="0"+s);var i=t.getHours(),n=t.getMinutes(),o=t.getSeconds();return i<10&&(i="0"+i),n<10&&(n="0"+n),o<10&&(o="0"+o),e+"/"+s+" "+i+":"+n+":"+o}getMinText(t){var e=t.getMinutes(),s=t.getSeconds(),i=t.getMilliseconds();return e<10&&(e="0"+e),s<10&&(s="0"+s),i<10?i="00"+i:i<100&&(i="0"+i),e+":"+s+"."+i}},o=s(0),r=s.n(o),a=["https://ntp-a1.nict.go.jp/cgi-bin/json","https://ntp-b1.nict.go.jp/cgi-bin/json","https://ntp-a4.nict.go.jp/cgi-bin/json"];var l=class{constructor(t=0){this.offset_jst=0,this.set_offset_friend(t),this.get_offset_jst()}get_time(t=Date.now()){var e=0;return this.offset_jst&&(e+=this.offset_jst),this.offset_friend&&(e+=this.offset_friend),new Date(t+e)}set_offset_friend(t){this.offset_friend=t}get_offset_jst(){this.results=new Array;const t=Math.floor(3*Math.random()),e=a[t];r()(e+"?"+(new Date).getTime()/1e3,(t,e)=>{if(!t){var s=new Date;e.st&&e.it&&e.leap&&e.next&&e.step&&(e.rt=s.getTime(),e.it=1e3*Number(e.it),e.st=1e3*Number(e.st),e.lb=e.it-16-e.st,e.ub=e.rt+16-e.st,this.offset_jst=-(e.lb+e.ub)/2)}})}};var d=class{constructor(t){this.scheme=t}load(){this.scheme,Object.keys(this.scheme).forEach(t=>{const e=this.scheme[t],s=e.type;var i=localStorage[t];null==i&&(i=e.default),s===Boolean?this[t]="true"==i||1==i:s===Number?this[t]=Number(i):s===String?this[t]=String(i):this[t]=i},this)}save(t,e){localStorage[t]=e,this[t]=e}};var u=class{constructor(){this.soundURLs=["1.wav","2.wav","3.wav","4.wav","5.wav","10.wav","30.wav","quite-impressed.mp3"].map(t=>"./sounds/"+t),this.sources=new Array(this.soundURLs.length),this.buffers=new Array(this.soundURLs.length),this.playing=new Array(this.soundURLs.length,!1),this.audioContext=window.AudioContext||window.webkitAudioContext,this.noAudioContext=!1,this.fallbackAudio,void 0!==this.audioContext?this.audioCtx=new this.audioContext:(this.noAudioContext=!0,this.fallbackAudio=document.createElement("audio"))}loadAll(){return Promise.all(this.soundURLs.map((t,e,s)=>this._load(e).then(t=>{t&&(this.buffers[e]=t)})))}playSilent(){this.audioCtx.resume();const t=this.audioCtx.createBuffer(1,1,22050),e=this.audioCtx.createBufferSource();e.buffer=t,e.connect(this.audioCtx.destination),e.start(0)}play(t){return this._load(t).then(e=>{if(this.noAudioContext)return this.fallbackAudio.currentTime=0,void this.fallbackAudio.play();this.audioCtx.resume();const s=this.audioCtx.createBufferSource();s&&(s.buffer=e,s.connect(this.audioCtx.destination),s.onended=function(){this.stop(t)},s.start(0),this.sources[t]=s,this.playing[t]=!0)})}stop(t){this.playing[t]=!1,this.sources[t]&&this.sources[t].stop(0),noAudioContext&&fallbackAudio.pause()}_load(t){const e=this.soundURLs[t];if(this.noAudioContext)return this.fallbackAudio.src=e,new Promise((t,e)=>{t(null)});this.audioCtx.resume();const s=this.buffers[t];return 1==!!s?new Promise((t,e)=>{t(s)}):new Promise((t,s)=>{const i=new XMLHttpRequest;i.open("GET",e,!0),i.responseType="arraybuffer",i.onload=()=>{4===i.readyState&&200===i.status?this.audioCtx.decodeAudioData(i.response,function(e){t(e)}):s(new Error(i.statusText))},i.onerror=()=>{s(new Error(i.statusText))},i.send(null)})}};const h=new n,c="mode_friend",f="mode_frequency_update",m="use_sound",g={};g[c]={type:Boolean,default:!1},g[f]={type:Boolean,default:!1},g[m]={type:Boolean,default:!1};class _{constructor(){this.sound=new u,this.sound_triggers=[1,2,3,4,5,10,30].map(t=>1e3*t),this.played_min=!1,this.least_sound_trigger=this.sound_triggers[this.sound_triggers.length-1],this.time_offset=new l,this.timer=new i(this.time_offset),this.config=new d(g),this.elmEta=document.getElementById("eta"),this.elmEtaArea=document.getElementById("eta_area"),this.elmEtaLabel=document.getElementById("eta_label"),this.elmOffset=document.getElementById("offset"),this.elmModeFriend=document.getElementById(c),this.elmModeFriend.addEventListener("click",this.on_change_modeFriend.bind(this)),this.elmModeFrequencyUpdate=document.getElementById(f),this.elmModeFrequencyUpdate.addEventListener("click",this.on_change_modeFrequencyUpdate.bind(this)),this.elmUseSound=document.getElementById(m),this.elmUseSound.addEventListener("click",this.on_change_useSound.bind(this)),this.elmLabelUseSound=document.getElementById(m+"_label");let t=t=>{this.sound.playSilent(),this.elmLabelUseSound.innerHTML="サウンド再生（制限解除済み）",this.elmLabelUseSound.classList.remove("mdl-color-text--deep-orange-900")};document.addEventListener("click",t),document.addEventListener("touchend",t),this.config.load(),this.on_load(),this.update(!0)}calc_eta(){this.list=this.timer.listup_next_STT();const t=this.time_offset.get_time(),e=this.list[0]-t;this.notify_sound(e),this.eta=new Date(e)}notify_sound(t){if(!this.useSound)return;if(t>this.least_sound_trigger)return void(this.played_min=!1);if(this.played_min)return;const e=this.sound_triggers.findIndex(e=>t<e);this.sound.play(e),this.played_min=e<=0;const s=this.played_min?this.sound_triggers.length-2:e-1;console.log(s),this.least_sound_trigger=this.sound_triggers[s]}update_eta(){const t=h.getMinText(this.eta);this.elmEta.innerHTML=t;let e="ST";if(0!=this.time_offset.offset_friend&&(e+="(フレ部屋)"),e+="まで",this.elmEtaLabel.innerHTML=e,this.time_offset.offset_jst){var s="";this.time_offset.offset_jst<0?s+="-"+h.getMinText(new Date(-this.time_offset.offset_jst)):s+="+"+h.getMinText(new Date(this.time_offset.offset_jst)),s+=" を補正済み",0!=this.time_offset.offset_friend&&(s+=" (更に2秒遅れ中)"),this.elmOffset.innerHTML=s}else this.elmOffset.innerHTML="時刻合わせ中 ..."}update_list(){for(let t in this.list){const e=document.getElementById("stt-item-"+(Number(t)+1)),s=h.getMonthText(this.list[t]);e.innerHTML=s}}update(t=!1){this.calc_eta(),this.update_eta(),this.update_list();const e=this.config[f];if(t){this.timeout&&clearTimeout(this.timeout);var s=1e3;(e||this.eta<6e4)&&(s=50),this.timeout=setTimeout(this.update.bind(this,!0),s)}}on_load(){this.elmModeFriend.checked=this.config[c],this.elmModeFrequencyUpdate.checked=this.config[f],this.elmUseSound.checked=this.config[m],this.on_change_modeFriend(),this.on_change_useSound(),this.on_change_modeFrequencyUpdate()}on_change_modeFriend(){const t=this.elmModeFriend.checked;this.elmEtaArea.classList.remove("mdl-color--grey-800"),this.elmEtaArea.classList.remove("mdl-color--green-900"),this.elmEtaLabel.classList.remove("mdl-color-text--grey-600"),this.elmEtaLabel.classList.remove("mdl-color-text--yellow-600"),this.elmOffset.classList.remove("mdl-color-text--grey-600"),this.elmOffset.classList.remove("mdl-color-text--yellow-600"),t?(this.time_offset.set_offset_friend(-2e3),this.elmEtaArea.classList.add("mdl-color--green-900"),this.elmEtaLabel.classList.add("mdl-color-text--yellow-600"),this.elmOffset.classList.add("mdl-color-text--yellow-600")):(this.time_offset.set_offset_friend(0),this.elmEtaArea.classList.add("mdl-color--grey-800"),this.elmEtaLabel.classList.add("mdl-color-text--grey-600"),this.elmOffset.classList.add("mdl-color-text--grey-600")),this.config.save(c,t),this.update(!1)}on_change_modeFrequencyUpdate(){const t=this.elmModeFrequencyUpdate.checked;this.config.save(f,t),this.update(!0)}on_change_useSound(){if(this.useSound=this.elmUseSound.checked,this.config.save(m,this.useSound),this.update(!1),this.useSound)return this.sound.loadAll(),void this.sound.play(7)}}window.onload=()=>{new _}}]);